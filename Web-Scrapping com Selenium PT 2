# Na segunda parte do Web-Scrapping com Selenium iremos começar com um processo de automatização de emissão de uma nota fiscal.
# Irei explicar passo a passo usando os arquivos do link: https://drive.google.com/drive/folders/1QxYWQUuFsETIh8ntXngQSQ0XPwTsq6Sy

# Nos arquivos em questão já está construída uma página que pode criar uma nota fiscal a partir de dados inseridos na página, então iremos fazer com que o programa escreva de forma automatizada todos os dados necessários para a emissão da nota.
# Vamos começar importando as bibliotecas necessárias:

from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.common.by import By

# Vamos definir algumas opções para poder fazer o download das notas ao final do código, uma vez que o navegador vai "se recusar" a fazer esse download caso não seja feita essa autorização
options = webdriver.ChromeOptions()
options.add_experimental_option("prefs", {
  "download.default_directory": r"C:\Users\lucascvalle\Desktop\Estudos\Python\Web-Scrapping com Selenium\Emissao de NFs\Notas", # Esse é o endereço da pasta onde quero que as notas sejam guardadas.
  "download.prompt_for_download": False,
  "download.directory_upgrade": True,
  "safebrowsing.enabled": True
})

servico = Service(ChromeDriverManager().install())
navegador = webdriver.Chrome(service=servico, options=options)

# Entrar na página de login (no nosso caso é login.html)
import os

caminho = os.getcwd()
arquivo = caminho + r"\login.html"
navegador.get(arquivo)

# Preencher o login e a senha
navegador.find_element(By.XPATH, '/html/body/div/form/input[1]').send_keys("email@seuemail.com")
navegador.find_element(By.XPATH, '/html/body/div/form/input[2]').send_keys("suasenha")

# Clicar no botao de fazer login
navegador.find_element(By.XPATH, '/html/body/div/form/button').click()

# Importar a base de clientes
import pandas as pd

tabela = pd.read_excel("NotasEmitir.xlsx") 
display(tabela)

# Para cada cliente - rodar o processo de emissao de nota fiscal
for linha in tabela.index:
    # preencher os dados da NF
    
    # nome/razao social
    navegador.find_element(By.NAME, 'nome').send_keys(tabela.loc[linha, "Cliente"])

    # endereco
    navegador.find_element(By.NAME, 'endereco').send_keys(tabela.loc[linha, "Endereço"])

    # bairro
    navegador.find_element(By.NAME, 'bairro').send_keys(tabela.loc[linha, "Bairro"])

    # municipio
    navegador.find_element(By.NAME, 'municipio').send_keys(tabela.loc[linha, "Municipio"])

    # cep
    navegador.find_element(By.NAME, 'cep').send_keys(str(tabela.loc[linha, "CEP"]))
    
    # UF
    navegador.find_element(By.NAME, 'uf').send_keys(tabela.loc[linha, "UF"])
    
    # CPF/CNPJ
    navegador.find_element(By.NAME, 'cnpj').send_keys(str(tabela.loc[linha, "CPF/CNPJ"]))

    # Inscricao estadual
    navegador.find_element(By.NAME, 'inscricao').send_keys(str(tabela.loc[linha, "Inscricao Estadual"]))

    # descrição
    texto = tabela.loc[linha, "Descrição"]
    navegador.find_element(By.NAME, 'descricao').send_keys(texto)

    # quantidade
    navegador.find_element(By.NAME, 'quantidade').send_keys(str(tabela.loc[linha, "Quantidade"]))

    # valor unitario
    navegador.find_element(By.NAME, 'valor_unitario').send_keys(str(tabela.loc[linha, "Valor Unitario"]))

    # valor total
    navegador.find_element(By.NAME, 'total').send_keys(str(tabela.loc[linha, "Valor Total"]))
    
    # clicar em emitir nota fiscal
    navegador.find_element(By.CLASS_NAME, 'registerbtn').click()
    
    # recarregar a página para limpar o formulário
    navegador.refresh()

